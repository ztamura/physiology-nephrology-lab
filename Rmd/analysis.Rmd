---
title: "Statistical Analysis"
author: "Zen Tamura"
date: 2021-09-08
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = TRUE)
# knitr::opts_chunk$set(error = FALSE)
# knitr::opts_chunk$set(message = FALSE)
# knitr::opts_chunk$set(warning = FALSE)

##########
knitr::opts_chunk$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
##########
```

```{r}
sessionInfo()
```

```{r imports}
library(tidyverse)
library(gridExtra)
library(ggsci)
library(ggpubr)
library(rstatix)
# library(ggplot2)
```


# 1. Load data

```{r}
# urine creatinine concentration in mg/dL
urine_creatinine_concentration <- read_csv("data/creatinine_concentration.csv", 
                                           skip = 1,
                                           locale = locale(encoding = "UTF-8"))
urine_creatinine_concentration <- rename(urine_creatinine_concentration, groups = `班/時間(min)`)

# urine flow rate in mL/min
urine_flow_rate <- read_csv("data/urine_flow_rate.csv", 
                            skip = 1,
                            locale = locale(encoding = "UTF-8"))
urine_flow_rate <- rename(urine_flow_rate, groups = `班/時間(min)`)

# osmotic pressure in mOSM/kg/H2O
osmotic_pressure <- read_csv("data/osmotic_pressure.csv", 
                            skip = 1,
                            locale = locale(encoding = "UTF-8"))
osmotic_pressure <- rename(osmotic_pressure, groups = `班/時間(min)`)

# pH
ph <- read_csv("data/ph.csv", 
               skip = 1,
               locale = locale(encoding = "UTF-8"))
ph <- rename(ph, groups = `班/時間(min)`)

# ammonia concentration in g/L
ammonia_concentration <- read_csv("data/ammonia_concentration.csv", 
                                  skip = 1,
                                  locale = locale(encoding = "UTF-8"))
ammonia_concentration <- rename(ammonia_concentration, groups = `班/時間(min)`)
```

```{r}
creatinine_clearance <- read_csv("result/creatinine_clearance_210908.csv",
                                 locale = locale(encoding = "UTF-8"))

free_water_clearance <- read_csv("result/free_water_clearance_210908.csv",
                                 locale = locale(encoding = "UTF-8"))

osmoles_clearance <- read_csv("result/osmoles_clearance_210908.csv",
                              locale = locale(encoding = "UTF-8"))

reabsorption_rate <- read_csv("result/reabsorption_rate_210918.csv",
                              locale = locale(encoding = "UTF-8"))
```

# Add ids

```{r}
urine_creatinine_conc_ids <- urine_creatinine_concentration %>% 
  rowid_to_column("id")

urine_flow_rate_ids <- urine_flow_rate %>% 
  rowid_to_column("id")

osmotic_pressure_ids <- osmotic_pressure %>% 
  rowid_to_column("id")

ph_ids <- ph %>% 
  rowid_to_column("id")

ammonia_concentration_ids <- ammonia_concentration %>% 
  rowid_to_column("id")

creatinine_clearance_ids <- creatinine_clearance %>% 
  rowid_to_column("id")

free_water_clearance_ids <- free_water_clearance %>% 
  rowid_to_column("id")

osmoles_clearance_ids <- osmoles_clearance %>% 
  rowid_to_column("id")

reabsorption_rate_ids <- reabsorption_rate %>% 
  rowid_to_column("id")
```



# Organize data for plots

```{r}
means <- vector("list", 30)
std_devs <- vector("list", 30)
std_errors <- vector("list", 30)

i <- 1
for (col in 2:ncol(urine_flow_rate)) {
    for (group in 1:6) {
        urine_data_frame <- data.frame(urine_flow_rate)
        start_row = (group - 1) * 14 + 1
        end_row = group * 14
        # print(as.vector(urine_data_frame[start_row:end_row, col]))
        mean <- mean(urine_data_frame[start_row:end_row, col])
        means[[i]] <- mean
        
        # print(mean)
        sd <- sd(urine_data_frame[start_row:end_row, col])
        # print(mean)
        # print(typeof(sd))
        std_error <- sd / sqrt(14)
        std_devs[[i]] <- sd
        std_errors[[i]] <- std_error
        print(means)
        
}

```


```{r}
summarize_data <- function(data, length=30) {
    # Summarizes data
    # Returns list w/ mean, standard deviation, and standard error
    
    # Args: data: input data, as a  tibble
    #       legnth: final length (# of rows) of output data frame
    # Returns: list
    
    means <- vector("list", length)
    std_devs <- vector("list", length)
    std_errors <- vector("list", length)
    groups <- vector("list", length)
    time <- vector("list", length)

    i <- 1
    for (col in 2:ncol(data)) {
        for (group in 1:6) {
            df <- data.frame(data)
            start_row <- (group - 1) * 14 + 1
            end_row <- group * 14
            mean <- mean(df[start_row:end_row, col])
            sd <- sd(df[start_row:end_row, col])
            std_error <- sd / sqrt(14)
            means[[i]] <- mean
            std_devs[[i]] <- sd
            std_errors[[i]] <- std_error
            groups[[i]] <- as.factor(group)
            time[[i]] <- as.integer(colnames(urine_flow_rate)[col])
            
            i <- i + 1
        }
    }
    stats <- list("means" = means, "std_devs" = std_devs, 
                  "std_errors" = std_errors, "groups" = groups,
                  "time" = time)
    
    return(stats)
}

create_summary_tibble <- function(summary_list) {
    # Creates tibble from summary_list
    output <- tibble("time" = unlist(summary_list$time),
                     "group" = unlist(summary_list$group),
                     "mean" = unlist(summary_list$means),
                     "standard_deviation" = unlist(summary_list$std_devs),
                     "standard_error" = unlist(summary_list$std_errors))
    return(output)
}

create_summary_df <- function(summary_list) {
    output <- data.frame("time" = unlist(summary_list$time),
                         "group" = unlist(summary_list$group),
                         "mean" = unlist(summary_list$means),
                         "standard_deviation" = unlist(summary_list$std_devs),
                         "standard_error" = unlist(summary_list$std_errors))
    return(output)
}


# stats <- summarize_data(urine_flow_rate)
# summary_tibble <- create_summary_tibble(stats)
# summary_tibble
# unlist(stats$means)
# unlist(stats$groups)
# unlist(stats$time)
```

# Summarize data

```{r}
# urine creatinine concentration
urine_creatinine_conc_stats <- summarize_data(urine_creatinine_concentration)
urine_creatinine_conc_summary_tibble <- create_summary_tibble(urine_creatinine_conc_stats)
urine_creatinine_conc_summary_df <- create_summary_df(urine_creatinine_conc_stats)

# urine flow rate
urine_flow_rate_stats <- summarize_data(urine_flow_rate)
urine_flow_rate_summary_tibble <- create_summary_tibble(urine_flow_rate_stats)
urine_flow_rate_summary_df <- create_summary_df(urine_flow_rate_stats)

# osmotic pressure
osmotic_pressure_stats <- summarize_data(osmotic_pressure)
osmotic_pressure_summary_tibble <- create_summary_tibble(osmotic_pressure_stats)
osmotic_pressure_summary_df <- create_summary_df(osmotic_pressure_stats)

# pH
ph_stats <- summarize_data(ph)
ph_summary_tibble <- create_summary_tibble(ph_stats)
ph_summary_df <- create_summary_df(ph_stats)

# ammonia concentration
ammonia_conc_stats <- summarize_data(ammonia_concentration)
ammonia_conc_summary_tibble <- create_summary_tibble(ammonia_conc_stats)
ammonia_conc_summary_df <- create_summary_df(ammonia_conc_stats)

# creatinine clearance
creatinine_clearance_stats <- summarize_data(creatinine_clearance)
creatinine_clearance_summary_tibble <- create_summary_tibble(creatinine_clearance_stats)
creatinine_clearance_summary_df <- create_summary_df(creatinine_clearance_stats)

# osmoles clearance
osmoles_clearance_stats <- summarize_data(osmoles_clearance)
osmoles_clearance_summary_tibble <- create_summary_tibble(osmoles_clearance_stats)
osmoles_clearance_summary_df <- create_summary_df(osmoles_clearance_stats)

# free water clearance
free_water_clearance_stats <- summarize_data(free_water_clearance)
free_water_clearance_summary_tibble <- create_summary_tibble(free_water_clearance_stats)
free_water_clearance_summary_df <- create_summary_df(free_water_clearance_stats)

# reabsorption rate
reabsorption_rate_stats <- summarize_data(reabsorption_rate)
reabsorption_rate_summary_tibble <- create_summary_tibble(reabsorption_rate_stats)
reabsorption_rate_summary_df <- create_summary_df(reabsorption_rate_stats)
```


# Reorganize data

```{r}
# urine_flow_rate %>%
#   gather(key = "time", value = "value", `0`, `30`, `60`, `90`, `120`) %>%
#   convert_as_factor(groups) %>% 
#   mutate(time = fct_reorder(time, .desc = FALSE))

reorganize_data <- function(input) {
  # Args:
  #   input: tibble
  
  output <- input %>% 
    gather(key = "time", value = "val", `0`, `30`, `60`, `90`, `120`) %>% 
    convert_as_factor(id, groups)
  output$time <- factor(output$time, levels = c(0, 30, 60, 90, 120))
  return(output)
}

```


```{r}
# urine creatinine concentration
urine_creatinine_conc_flattened <- reorganize_data(urine_creatinine_conc_ids)

# urine flow rate
urine_flow_rate_flattened <- reorganize_data(urine_flow_rate_ids)

# osmotic pressure
osmotic_pressure_flattened <- reorganize_data(osmotic_pressure_ids)

# pH
ph_flattened <- reorganize_data(ph_ids)

# ammonia concentration
ammonia_conc_flattened <- reorganize_data(ammonia_concentration_ids)

# creatinine clearance
creatinine_clearance_flattened <- reorganize_data(creatinine_clearance_ids)

# osmoles clearance
osmoles_clearance_flattened <- reorganize_data(osmoles_clearance_ids)

# free water clearance
free_water_clearance_flattened <- reorganize_data(free_water_clearance_ids)

# reabsorption rate
reabsorption_rate_flattened <- reorganize_data(reabsorption_rate_ids)
```

# Create plots

## 1. Time vs urine flow rate

```{r}
time_vs_urine_flow_rate <- urine_flow_rate_summary_df %>% 
    ggplot(aes(x = time, y = mean, color = group)) +
    geom_line() +
    geom_errorbar(aes(ymin = mean - standard_error,
                      ymax = mean + standard_error,
                      width = 0.4)) +
    theme_bw() + 
    scale_color_npg()
time_vs_urine_flow_rate
```

## General time function

```{r}
create_time_plots <- function(summary_df) {
    # Args:
    #   summary_df: data frame
    plot <- summary_df %>% 
        ggplot(aes(x = time, y = mean, color = group)) +
        geom_line() +
        geom_errorbar(aes(ymin = mean - standard_error,
                          ymax = mean + standard_error,
                          width = 1.8)) +
        scale_x_continuous(breaks = seq(0, 120, by = 30)) +
        theme_bw() +
        scale_color_npg()
    return(plot)
}

```



```{r}
time_vs_urine_flow_rate <- create_time_plots(urine_flow_rate_summary_df)
time_vs_urine_flow_rate +
  labs(y = "urine flow rate") +
  ggsave("result/time_vs_urine_flow_rate_210918.pdf")

time_vs_ph <- create_time_plots(ph_summary_df)
time_vs_ph + 
    labs(y = "pH") + 
    ggsave("result/time_vs_ph_210918.pdf")

# ammonia concentration
time_vs_ammonia_conc <- create_time_plots(ammonia_conc_summary_df)
time_vs_ammonia_conc +
    labs(y = "[Ammonia]  (g/L)") +
    ggsave("result/time_vs_ammonia_conc_210918.pdf")
# ggsave("result/time_vs_ammonia_conc.pdf", time_vs_ammonia_conc)

# creatinine conc
time_vs_urine_creatinine_conc <- create_time_plots(urine_creatinine_conc_summary_df)
time_vs_urine_creatinine_conc +
    labs(y = "[Creatinine]  (mg/dL)") +
    ggsave("result/time_vs_urine_creatinine_conc_210918.pdf")
# ggsave("result/time_vs_urine_creatinine_conc.pdf", time_vs_urine_creatinine_conc)

# osmolarity
time_vs_osmolarity <- create_time_plots(osmotic_pressure_summary_df)
time_vs_osmolarity +
    labs(y = "Osmolarity (mOsm/kg/H2O)") +
    ggsave("result/time_vs_osmolarity_210918.pdf")

# creatinine clearance
time_vs_creatinine_clearance <- create_time_plots(creatinine_clearance_summary_df)
time_vs_creatinine_clearance +
    labs(y = "Creatinine clearance (mL/min)") +
    ggsave("result/time_vs_creatinine_clearance_210918.pdf")

# Clearance of osmoles
time_vs_osmoles_clearance <- create_time_plots(osmoles_clearance_summary_df)
time_vs_osmoles_clearance +
    labs(y = "Clearance of osmoles (mL/min)") +
    ggsave("result/time_vs_osmoles_clearance_210918.pdf")

# Free water clearance
time_vs_free_water_clearance <- create_time_plots(free_water_clearance_summary_df)
time_vs_free_water_clearance +
    labs(y = "Free water clearance (mL/min)") +
    ggsave("result/time_vs_free_water_clearance_210918.pdf")

# reabsorption rate
time_vs_reabsorption_rate <- create_time_plots(reabsorption_rate_summary_df)
time_vs_reabsorption_rate +
    labs(y = "Water reabsorption rate (mL/min)") +
    ggsave("result/time_vs_reabsorption_rate_210918.pdf")
```


# Generate QQ plots

```{r}
generate_qq_plots <- function(data, data_name) {
    i <- 1
    for (col in 2:ncol(data)) {
        for (group in 1:6) {
            df <- data.frame(data)
            start_row <- (group - 1) * 14 + 1
            end_row <- group * 14
            plot <- ggplot(mapping = aes(sample = df[start_row:end_row, col])) +
                stat_qq(size = 2) +
                stat_qq_line(color = "blue") +
                theme_bw() +
                labs(x = "Theoretical Quantiles",
                     y = "Sample Quantiles",
                     title = paste("Data: ", data_name, ", Group: ", group,  
                                   ", Time: ", colnames(urine_flow_rate)[col]), sep = "")
            filename <- paste("data_", data_name, "_group_", group, "_time_",
                              colnames(urine_flow_rate)[col], ".pdf", sep = "")
            
            dir_path <- paste("result/qqplots/", data_name, sep = "")
            if (!dir.exists(dir_path)){
                dir.create(dir_path, showWarnings = FALSE)
            }
            full_path <- paste("result/qqplots/", data_name, "/", filename, sep = "")
            ggsave(full_path, plot)
        }
        
    }
}
# generate_qq_plots(urine_flow_rate, "urine_flow_rate")
```


# Generate qq plots

```{r}
generate_qq_plots(urine_creatinine_concentration, "urine_creatinine_concentration")
generate_qq_plots(osmotic_pressure, "osmotic_pressure")
generate_qq_plots(ph, "ph")
generate_qq_plots(ammonia_concentration, "ammonia_concentration")
generate_qq_plots(creatinine_clearance, "creatinine_clearance")
generate_qq_plots(free_water_clearance, "free_water_clearance")
generate_qq_plots(osmoles_clearance, "osmoles_clearance")
generate_qq_plots(reabsorption_rate, "reabsorption_rate")
```


## Faceted QQ plots

```{r}
bxp <- ggboxplot(urine_flow_rate_flattened, x = "time", y = "val",
                 color = "groups", palette = "jco")
bxp

plot <- ggqqplot(urine_flow_rate_flattened, "val", ggtheme = theme_bw(), 
         conf.int = TRUE, conf.int.level = 0.95, size = 0.7, color = "black") +
  facet_grid(time ~ groups, labeller = "label_both") + 
  labs(x = "Theoretical Quantiles",
       y = "Sample Quantiles",
       title = "Test")
plot$layers[[1]]$aes_params$colour <- "red"
plot$layers[[2]]$aes_params$size <- 0.6
plot
```




```{r}
generate_faceted_qq_plots <- function(data, data_name) {
  qqplot <- ggqqplot(data, "val", ggtheme = theme_bw(),
                     conf.int = FALSE, size = 0.7, color = "black") +
    facet_grid(time ~ groups, labeller = "label_both") + 
    labs(x = "Theoretical Quantiles",
         y = "Sample Quantiles",
         title = paste("Data: ", data_name, sep = "")) 
  qqplot$layers[[1]]$aes_params$colour <- "red"
  qqplot$layers[[2]]$aes_params$size <- 0.5
  filename <- paste(data_name, ".pdf", sep = "")
  dir_path <- paste("result/qqplots/", data_name, sep = "")
  if (!dir.exists(dir_path)) {
    dir.create(dir_path, showWarnings = FALSE)
  }
  full_path <- paste("result/qqplots/", data_name, "/", filename, sep = "")
  # ggsave(full_path, qqplot)
  return(qqplot)
  
}
```

```{r}
generate_faceted_qq_plots_test <- function(data, data_name) {
  qqplot <- ggqqplot(data, "val", ggtheme = theme_bw(),
                     conf.int = FALSE, size = 0.7, color = "black") +
    facet_grid(time ~ groups, labeller = "label_both") + 
    labs(x = "Theoretical Quantiles",
         y = "Sample Quantiles",
         title = paste("Data: ", data_name, sep = "")) 
  qqplot$layers[[1]]$aes_params$colour <- "red"
  qqplot$layers[[2]]$aes_params$size <- 0.5
  
  
  # filename <- paste(data_name, ".pdf", sep = "")
  # dir_path <- paste("result/qqplots/", data_name, sep = "")
  # if (!dir.exists(dir_path)) {
  #   dir.create(dir_path, showWarnings = FALSE)
  # }
  # full_path <- paste("result/qqplots/", data_name, "/", filename, sep = "")
  # ggsave(full_path, qqplot)
  return(qqplot)
  
}
```



```{r}
generate_faceted_qq_plots(urine_creatinine_conc_flattened, "urine_creatinine_concentration")
generate_faceted_qq_plots(osmotic_pressure_flattened, "osmotic_pressure")
generate_faceted_qq_plots(ph_flattened, "ph")
generate_faceted_qq_plots(ammonia_conc_flattened, "ammonia_concentration")
generate_faceted_qq_plots(creatinine_clearance_flattened, "creatinine_clearance")
generate_faceted_qq_plots(free_water_clearance_flattened, "free_water_clearance")
generate_faceted_qq_plots(osmoles_clearance_flattened, "osmoles_clearance")
generate_faceted_qq_plots(reabsorption_rate_flattened, "reabsorption_rate")
generate_faceted_qq_plots(urine_flow_rate_flattened, "urine_flow_rate")
```



# Shapiro-Wilk test

```{r}
urine_flow_rate_df <- data.frame(urine_flow_rate)
urine_flow_rate_df[1:14, 2]
result <- shapiro.test(urine_flow_rate_df[1:14, 2])
result$p.value
colnames(urine_flow_rate_df)
```

```{r}
run_shapiro_test <- function(data, length = 30) {
  # Testing for normality using the Shapiro-Wilk test
  df <- data.frame(data)
  i <- 1
  p_values <- vector("list", length)
  test_statistic <- vector("list", length)
  # alt_hypothesis <- vector("list", length)
  time <- vector("list", length)
  groups <- vector("list", length)
  for (col in 2:ncol(data)) {
    for (group in 1:6) {
      start_row <- (group - 1) * 14 + 1
      end_row <- group * 14
      shapiro_test_result <- shapiro.test(df[start_row:end_row, col])
      p_values[[i]] <- shapiro_test_result$p.value
      test_statistic[[i]] <- shapiro_test_result$statistic
      # alt_hypothesis[[i]] <- ks_test_result$alternative
      groups[[i]] <- as.factor(group)
      time[[i]] <- as.integer(colnames(data)[col])
      i <- i + 1
    }
  }
  ks_result_aggr <- list("time" = time, "groups" = groups, "p_values" = p_values,
                         "test_statistic" = test_statistic)
  return(ks_result_aggr)
  
}
shapiro_result <- run_shapiro_test(urine_flow_rate)
shapiro_result
```


```{r}
create_shapiro_summary_df <- function(summary_list) {
  # Aggregates Shapiro-Wilk test results into a data frame
  output <- data.frame("time" = unlist(summary_list$time),
                       "group" = unlist(summary_list$group),
                       "p_value"= unlist(summary_list$p_values),
                       "test_statistic" = unlist(summary_list$test_statistic))
  return(output)
}

```


```{r}
# urine creatinine concentration
urine_creatinine_conc_shapiro_list <- run_shapiro_test(urine_creatinine_concentration)
urine_creatinine_conc_shapiro_df <- create_shapiro_summary_df(urine_creatinine_conc_shapiro_list)

# urine flow rate
urine_flow_rate_shapiro_list <- run_shapiro_test(urine_flow_rate)
urine_flow_rate_shapiro_df <- create_shapiro_summary_df(urine_flow_rate_shapiro_list)

# osmotic pressure
osmotic_pressure_shapiro_list <- run_shapiro_test(osmotic_pressure)
osmotic_pressure_shapiro_df <- create_shapiro_summary_df(osmotic_pressure_shapiro_list)

# pH
ph_shapiro_list <- run_shapiro_test(ph)
ph_shapiro_df <- create_shapiro_summary_df(ph_shapiro_list)

# ammonia concentration
ammonia_conc_shapiro_list <- run_shapiro_test(ammonia_concentration)
ammonia_shapiro_df <- create_shapiro_summary_df(ammonia_conc_shapiro_list)

# creatinine clearance
creatinine_clearance_shapiro_list <- run_shapiro_test(creatinine_clearance)
creatinine_clearance_shapiro_df <- create_shapiro_summary_df(creatinine_clearance_shapiro_list)

# clearance of osmoles
osmoles_clearance_shapiro_list <- run_shapiro_test(osmoles_clearance)
osmoles_clearance_shapiro_df <- create_shapiro_summary_df(osmoles_clearance_shapiro_list)

# free water clearance
free_water_clearance_shapiro_list <- run_shapiro_test(free_water_clearance)
free_water_clearance_shapiro_df <- create_shapiro_summary_df(free_water_clearance_shapiro_list)

# reabsorption rate
reabsorption_rate_shapiro_list <- run_shapiro_test(reabsorption_rate)
reabsorption_rate_shaprio_df <- create_shapiro_summary_df(reabsorption_rate_shapiro_list)
```

## simple Shapiro-Wilk test

```{r}
# urine_flow_rate_flattened %>% 
#   group_by(groups, time) %>% 
#   get_summary_stats(value, type = "mean_sd")

urine_flow_rate_flattened %>% 
  group_by(groups, time) %>% 
  shapiro_test(val) %>% 
  filter(p >= 0.05)
```

```{r}
run_simple_shapiro_wilk <- function(data) {
  data %>% 
    group_by(groups, time) %>% 
    shapiro_test(val)
}
```


```{r}
urine_creatinine_conc_shapiro_result <- run_simple_shapiro_wilk(urine_creatinine_conc_flattened)
urine_flow_rate_shapiro_result <- run_simple_shapiro_wilk(urine_flow_rate_flattened)
osmotic_pressure_shapiro_result <- run_simple_shapiro_wilk(osmotic_pressure_flattened)
ph_shapiro_result <- run_simple_shapiro_wilk(ph_flattened)
ammonia_conc_shapiro_result <- run_simple_shapiro_wilk(ammonia_conc_flattened)
creatinine_clearance_shapiro_result <- run_simple_shapiro_wilk(creatinine_clearance_flattened)
osmoles_clearance_shapiro_result <- run_simple_shapiro_wilk(osmoles_clearance_flattened)
free_water_clearance_shapiro_result <- run_simple_shapiro_wilk(free_water_clearance_flattened)
reabsorption_rate_shapiro_result <- run_simple_shapiro_wilk(reabsorption_rate_flattened)
```

```{r}
urine_flow_rate_shapiro_result_mod <- urine_flow_rate_shapiro_result %>% 
  mutate(p_sci = format(p, digits = 3, scientific = TRUE)) %>% 
  mutate(p_sci = paste("P =", p_sci))
```


```{r}
# ggqqplot(urine_flow_rate_flattened, "val", ggtheme = theme_bw(),
#                      conf.int = FALSE, size = 0.7, color = "black") +
#     facet_grid(time ~ groups, labeller = "label_both") + 
#     geom_text(data = urine_flow_rate_shapiro_result_mod, aes(x = -0.1, y = 18, label = p_sci), 
#               size = 2.6, inherit.aes = FALSE)


generate_faceted_qq_plots_with_shapiro <- function(data, data_name, shapiro_result) {
  shapiro_result_mod <- shapiro_result %>% 
    mutate(p_sci = format(p, digits = 3, scientific = TRUE)) %>% 
    mutate(p_sci = paste("P =", p_sci))
  
  qqplot <- ggqqplot(data, "val", ggtheme = theme_bw(),
                     conf.int = FALSE, size = 0.7, color = "black") +
    facet_grid(time ~ groups, labeller = "label_both") + 
    geom_text(data = shapiro_result_mod, aes(x = -0.5, y = 16, label = p_sci),
              size = 2.9, inherit.aes = FALSE) +
    labs(x = "Theoretical Quantiles",
         y = "Sample Quantiles",
         title = paste("Data: ", data_name, sep = ""))
  qqplot$layers[[1]]$aes_params$colour <- "red"
  qqplot$layers[[2]]$aes_params$size <- 0.5
  
  
  filename <- paste(data_name, "_with_shapiro", ".pdf", sep = "")
  dir_path <- paste("result/qqplots/", data_name, sep = "")
  if (!dir.exists(dir_path)) {
    dir.create(dir_path, showWarnings = FALSE)
  }
  full_path <- paste("result/qqplots/", data_name, "/", filename, sep = "")
  ggsave(full_path, qqplot)
  return(qqplot)
  
}
```

```{r}
# generate_faceted_qq_plots_with_shapiro(urine_creatinine_conc_flattened,
#                                        "urine_creatinine_concentration",
#                                        urine_creatinine_conc_shapiro_result)

# generate_faceted_qq_plots_with_shapiro(urine_flow_rate_flattened, "urine_flow_rate",
#                                        urine_flow_rate_shapiro_result)

# generate_faceted_qq_plots_with_shapiro(osmotic_pressure_flattened,
#                                        "osmotic_pressure",
#                                        osmotic_pressure_shapiro_result)

# generate_faceted_qq_plots_with_shapiro(ph_flattened,
#                                        "ph",
#                                        ph_shapiro_result)

# generate_faceted_qq_plots_with_shapiro(ammonia_conc_flattened,
#                                        "ammonia_concentration",
#                                        ammonia_conc_shapiro_result)

# generate_faceted_qq_plots_with_shapiro(creatinine_clearance_flattened,
#                                        "creatinine_clearance",
#                                        creatinine_clearance_shapiro_result)

# generate_faceted_qq_plots_with_shapiro(osmoles_clearance_flattened,
#                                        "osmoles_clearance",
#                                        osmoles_clearance_shapiro_result)

# generate_faceted_qq_plots_with_shapiro(free_water_clearance_flattened,
#                                        "free_water_clearance",
#                                        free_water_clearance_shapiro_result)
# 
# generate_faceted_qq_plots_with_shapiro(reabsorption_rate_flattened,
#                                        "reabsorption_rate",
#                                        reabsorption_rate_shapiro_result)
```


```{r}
write_csv(urine_creatinine_conc_shapiro_result, 
          "result/shapiro_wilk/urine_creatinine_concentration/urine_creatinine_conc_shapiro_result.csv")

write_csv(urine_flow_rate_shapiro_result,
          "result/shapiro_wilk/urine_flow_rate/urine_flow_rate_shapiro_result.csv")

write_csv(osmotic_pressure_shapiro_result,
          "result/shapiro_wilk/osmotic_pressure/osmotic_pressure_shapiro_result.csv")

write_csv(ph_shapiro_result,
          "result/shapiro_wilk/ph/ph_shapiro_result.csv")

write_csv(ammonia_conc_shapiro_result,
          "result/shapiro_wilk/ammonia_concentration/ammonia_conc_shapiro_result.csv")

write_csv(creatinine_clearance_shapiro_result,
          "result/shapiro_wilk/creatinine_clearance/creatinine_clearance_shapiro_result.csv")

write_csv(osmoles_clearance_shapiro_result,
          "result/shapiro_wilk/osmoles_clearance/osmoles_clearance_shapiro_result.csv")

write_csv(free_water_clearance_shapiro_result,
          "result/shapiro_wilk/free_water_clearance/free_water_clearance_shapiro_result.csv")

write_csv(reabsorption_rate_shapiro_result,
          "result/shapiro_wilk/reabsorption_rate/reabsorption_rate_shapiro_result.csv")
```


```{r}
run_shapiro_test <- function(data, length = 30) {
  # Testing for normality using the Shapiro-Wilk test
  df <- data.frame(data)
  i <- 1
  p_values <- vector("list", length)
  test_statistic <- vector("list", length)
  # alt_hypothesis <- vector("list", length)
  time <- vector("list", length)
  groups <- vector("list", length)
  for (col in 2:ncol(data)) {
    for (group in 1:6) {
      start_row <- (group - 1) * 14 + 1
      end_row <- group * 14
      shapiro_test_result <- shapiro.test(df[start_row:end_row, col])
      p_values[[i]] <- shapiro_test_result$p.value
      test_statistic[[i]] <- shapiro_test_result$statistic
      # alt_hypothesis[[i]] <- ks_test_result$alternative
      groups[[i]] <- as.factor(group)
      time[[i]] <- as.integer(colnames(data)[col])
      i <- i + 1
    }
  }
  ks_result_aggr <- list("time" = time, "groups" = groups, "p_values" = p_values,
                         "test_statistic" = test_statistic)
  return(ks_result_aggr)
  
}
```




### Urine creatinine concentration

Urine creatinine concentration: 10/30 data sets are normal.
```{r}
urine_creatinine_conc_shapiro_df %>% 
  filter(p_value >= 0.05)
```

Non-normal distributions:
```{r}
urine_creatinine_conc_shapiro_df %>% 
  filter(p_value < 0.05)
```

Urine flow rate: 14/30 data sets are normal

```{r}
urine_flow_rate_shapiro_df %>% 
  filter(p_value >= 0.05)
```

Osmotic pressure: 21/30 data sets are normal

```{r}
osmotic_pressure_shapiro_df %>% 
  filter(p_value >= 0.05)
```

pH: 10/30 data sets are normal

```{r}
ph_shapiro_df %>% 
  filter(p_value >= 0.05)
```

ammonia concentration: 17/30 data sets are normally distributed

```{r}
ammonia_shapiro_df %>% 
  filter(p_value >= 0.05)
```

cratinine clearance: 9/30 data sets are normally distributed

```{r}
creatinine_clearance_shapiro_df %>% 
  filter(p_value >= 0.05)
```

osmoles clearance 22/30 data sets are normally distributed

```{r}
osmoles_clearance_shapiro_df %>% 
  filter(p_value >= 0.05)
```

Free water clearance: 21/30 data sets are normally distributed

```{r}
free_water_clearance_shapiro_df %>% 
  filter(p_value >= 0.05)
```

Reabsorption rate: 9/30 data sets are normally distributed

```{r}
reabsorption_rate_shaprio_df %>% 
  filter(p_value >= 0.05)
```



# 2-way repeated measures ANOVA

```{r}
anova_result <- anova_test(
  data = urine_flow_rate_flattened, dv = val, wid = id,
  within = time,
  between = groups)
table <- get_anova_table(anova_result)
table
typeof(table)
anova_result$`Sphericity Corrections`
```

```{r}
run_mixed_anova <- function(data) {
  anova_result <- anova_test(
    data = data, dv = val, wid = id, within = time, between = groups)
  anova_table <- get_anova_table(anova_result)
  result_list <- list("anova_result" = anova_result, "anova_table" = anova_table)
  return(result_list)
}
```

Creatinine clearance (group) & reabsorption rate (group) not significant

```{r}
urine_creatinine_conc_anova <- run_mixed_anova(urine_creatinine_conc_flattened)
urine_flow_rate_anova <- run_mixed_anova(urine_flow_rate_flattened)
osmotic_pressure_anova <- run_mixed_anova(osmotic_pressure_flattened)
ph_anova <- run_mixed_anova(ph_flattened)
ammonia_conc_anova <- run_mixed_anova(ammonia_conc_flattened)
creatinine_clearance_anova <- run_mixed_anova(creatinine_clearance_flattened)
osmoles_clearance_anova <- run_mixed_anova(osmoles_clearance_flattened)
free_water_clearance_anova <- run_mixed_anova(free_water_clearance_flattened)
reabsorption_rate_anova <- run_mixed_anova(reabsorption_rate_flattened)
```


# Simple main effect of group variable

Check between-subject factor `group` at every `time` point.

```{r}
# test
one_way <- urine_flow_rate_flattened %>% 
  group_by(time) %>% 
  anova_test(dv = val, wid = id, between = groups) %>% 
  get_anova_table %>% 
  adjust_pvalue(method = "BH")
one_way
```

## pairwise comparisons

```{r}
pwc <- urine_flow_rate_flattened %>% 
  group_by(time) %>% 
  pairwise_t_test(val ~ groups, p.adjust.method = "BH")
# pwc %>% 
#   filter(p.adj < 0.05)

pwc <- pwc %>% 
  add_xy_position(x = "time")
pwc

pwc_filtered <- pwc %>%
  filter(time != "0")

bxp <- ggboxplot(urine_flow_rate_flattened, x = "time", y = "val",
                 color = "groups", palette = "jco") +
  stat_pvalue_manual(pwc_filtered, tip.length = 0, hide.ns = TRUE)
bxp
```

# Pair-wise test function

```{r}
run_pairwise_t_tests_groups <- function(data, data_name, anova_result,  p_adj_method = "BH") {
  # Runs pairwise t tests and creates boxplots for groups
  # Args:
  #   data: input data
  #   anova_result: anova result

  pwc <- data %>% 
    group_by(time) %>% 
    pairwise_t_test(val ~ groups, p.adjust.method = p_adj_method) %>% 
    add_xy_position(x = "time")
  
  boxplot <- ggboxplot(data, x = "time", y = "val",
                       color = "groups", palette = "jco") +
    stat_pvalue_manual(pwc, tip.length = 0, hide.ns = TRUE) +
    labs(subtitle = get_test_label(anova_result, detailed = TRUE),
         caption = get_pwc_label(pwc))
  
  # filename <- paste(data_name, ".pdf", sep = "")
  # dir_path <- paste("result/group_pairwise_t_test_plots/", data_name, sep = "")
  # if (!dir.exists(dir_path)) {
  #   dir.create(dir_path, showWarnings = FALSE)
  # }
  # full_path <- paste("result/group_pairwise_t_test_plots/", data_name, "/", 
  #                    filename, sep = "")
  # ggsave(full_path, boxplot)
  
  pwc_export <- data %>% 
    group_by(time) %>% 
    pairwise_t_test(val ~ groups, p.adjust.method = p_adj_method) 
  
  filename <- paste(data_name, ".csv", sep = "")
  dir_path <- paste("result/group_pairwise_t_test_csv/", data_name, sep = "")
  if (!dir.exists(dir_path)) {
    dir.create(dir_path, showWarnings = FALSE)
  }
  full_path <- paste("result/group_pairwise_t_test_csv/", data_name, "/",
                     filename, sep = "")
  write_csv(pwc_export, full_path)
  
  return(pwc)
}
```

```{r}
run_pairwise_t_tests_groups(urine_creatinine_conc_flattened, "urine_creatinine_concentration",
                            urine_creatinine_conc_anova$anova_result)
run_pairwise_t_tests_groups(urine_flow_rate_flattened, "urine_flow_rate",
                            urine_flow_rate_anova$anova_result)
run_pairwise_t_tests_groups(osmotic_pressure_flattened, "osmotic_pressure",
                            osmotic_pressure_anova$anova_result)
run_pairwise_t_tests_groups(ph_flattened, "ph",
                            ph_anova$anova_result)
run_pairwise_t_tests_groups(ammonia_conc_flattened, "ammonia_concentration",
                            ammonia_conc_anova$anova_result)
run_pairwise_t_tests_groups(creatinine_clearance_flattened, "creatinine_clearance",
                            creatinine_clearance_anova$anova_result)
run_pairwise_t_tests_groups(osmoles_clearance_flattened, "osmoles_clearance",
                            osmoles_clearance_anova$anova_result)
run_pairwise_t_tests_groups(free_water_clearance_flattened, "free_water_clearance",
                            free_water_clearance_anova$anova_result)
run_pairwise_t_tests_groups(reabsorption_rate_flattened, "reabsorption_rate",
                            reabsorption_rate_anova$anova_result)
```


```{r}

run_pairwise_t_tests_time <- function(data, data_name, anova_result,  p_adj_method = "BH") {
  # Runs pairwise t tests and creates boxplots for groups
  # Args:
  #   data: input data
  #   anova_result: anova result

  pwc <- data %>% 
    group_by(groups) %>% 
    pairwise_t_test(val ~ time, p.adjust.method = p_adj_method)
  
  filename <- paste(data_name, ".csv", sep = "")
  dir_path <- paste("result/time_pairwise_t_test_csv/", data_name, sep = "")
  if (!dir.exists(dir_path)) {
    dir.create(dir_path, showWarnings = FALSE)
  }
  full_path <- paste("result/time_pairwise_t_test_csv/", data_name, "/",
                     filename, sep = "")
  write_csv(pwc, full_path)
  return(pwc)
}
run_pairwise_t_tests_time(urine_creatinine_conc_flattened, "urine_creatinine_concentration",
                            urine_creatinine_conc_anova$anova_result)
```


```{r}
run_pairwise_t_tests_time(urine_creatinine_conc_flattened, "urine_creatinine_concentration",
                            urine_creatinine_conc_anova$anova_result)
run_pairwise_t_tests_time(urine_flow_rate_flattened, "urine_flow_rate",
                            urine_flow_rate_anova$anova_result)
run_pairwise_t_tests_time(osmotic_pressure_flattened, "osmotic_pressure",
                            osmotic_pressure_anova$anova_result)
run_pairwise_t_tests_time(ph_flattened, "ph",
                            ph_anova$anova_result)
run_pairwise_t_tests_time(ammonia_conc_flattened, "ammonia_concentration",
                            ammonia_conc_anova$anova_result)
run_pairwise_t_tests_time(creatinine_clearance_flattened, "creatinine_clearance",
                            creatinine_clearance_anova$anova_result)
run_pairwise_t_tests_time(osmoles_clearance_flattened, "osmoles_clearance",
                            osmoles_clearance_anova$anova_result)
run_pairwise_t_tests_time(free_water_clearance_flattened, "free_water_clearance",
                            free_water_clearance_anova$anova_result)
run_pairwise_t_tests_time(reabsorption_rate_flattened, "reabsorption_rate",
                            reabsorption_rate_anova$anova_result)
```


```{r}
set.seed(123)
data("anxiety", package = "datarium")
anxiety <- anxiety %>% 
  gather(key = "time", value = "score", t1, t2, t3) %>% 
  convert_as_factor(id, time)

bxp <- ggboxplot(
  anxiety, x = "time", y = "score", color = "group", palette = "jco")
bxp

pwc <- anxiety %>% 
  group_by(time) %>% 
  pairwise_t_test(score ~ group, p.adjust.method = "bonferroni")
pwc <- pwc %>% 
  add_xy_position(x = "time")
pwc.filtered <- pwc %>% 
  filter(time != "t1")
bxp + 
  stat_pvalue_manual(pwc.filtered, tip.length = 0, hide.ns = TRUE)
```




# Pairwise t-tests

```{r}
one_way <- urine_flow_rate_flattened %>% 
  group_by(time) %>% 
  anova_test(dv = val, wid = id, between = groups) %>% 
  get_anova_table() %>% 
  adjust_pvalue(method = "bonferroni")
one_way
```

pairwise tests

```{r}
pwc <- urine_flow_rate_flattened %>% 
  group_by(time) %>% 
  pairwise_t_test(val ~ groups, p.adjust.method = "BH")
pwc %>% 
  filter(p.adj < 0.05)
```




# Kruskal-Wallist test

```{r}
urine_flow_rate_flattened %>% 
  group_by(time) %>% 
  kruskal_test(val ~ groups) %>% 
  filter(p < 0.05)

urine_flow_rate_flattened %>% 
  group_by(time) %>% 
  dunn_test(val ~ groups, p.adjust.method = "bonferroni") %>% 
  filter(p.adj < 0.05)

urine_flow_rate_flattened %>% 
  group_by(groups, time) %>% 
  shapiro_test(val) %>% 
  filter(p >= 0.05)
```


## Kurskal-Wallis w/ Dunn's test post-hoc

```{r}
result <- urine_flow_rate_flattened %>% 
  group_by(time) %>% 
  kruskal_test(val ~ groups) %>% 
  filter(p < 0.05)
length(result$time)

result %>% 
  filter(time %in% result$time)
```


```{r}
run_kruskal_wallis_dunn <- function(data, data_name, p_adj_method = "BH", alpha = 0.05) {
  kruskal_wallis_result <- data %>% 
    group_by(time) %>% 
    kruskal_test(val ~ groups) 
  
  kruskal_wallis_result_filtered <- kruskal_wallis_result %>% 
    filter(p < alpha)
  
  # Dunn's test post-hoc
  dunn_result <- data %>% 
    group_by(time) %>% 
    filter(time %in% kruskal_wallis_result_filtered$time) %>% 
    dunn_test(val ~ groups, p.adjust.method = p_adj_method)
  
  kw_filename <- paste(data_name, "_kruskal-wallis_", p_adj_method, ".csv", sep = "")
  dir_name <- "result/group_kruskal_wallis_csv/"
  dir_path <- paste(dir_name, data_name, sep = "")
  if (!dir.exists(dir_path)) {
    dir.create(dir_path, showWarnings = FALSE)
  }
  full_path <- paste(dir_name, data_name, "/",
                     kw_filename, sep = "")
  write_csv(kruskal_wallis_result, full_path)
  
  # Dunn's test post-hoc
  
  dunn_filename <- paste(data_name, "_dunn_", p_adj_method, ".csv", sep = "")
  dunn_full_path <- paste(dir_name, data_name, "/", dunn_filename, sep = "")
  write_csv(dunn_result, dunn_full_path)
  
  kruskal_wallis_aggr <- list("kruskal-wallis_unfiltered" = kruskal_wallis_result,
                              "dunn_unfiltered" = dunn_result)
  
  return(kruskal_wallis_aggr)
}
```


```{r}
urine_creatinine_conc_kruskal_wallis_dunn <- run_kruskal_wallis_dunn(urine_creatinine_conc_flattened,
                                                                     "urine_creatinine_concentration")
urine_flow_rate_kruskal_wallis_dunn <- run_kruskal_wallis_dunn(urine_flow_rate_flattened,
                                                               "urine_flow_rate")
osmotic_pressure_kruskal_wallis_dunn <- run_kruskal_wallis_dunn(osmotic_pressure_flattened,
                                                                "osmotic_pressure")
ph_kruskal_wallis_dunn <- run_kruskal_wallis_dunn(ph_flattened,
                                                  "ph")
ammonia_conc_kruskal_wallis_dunn <- run_kruskal_wallis_dunn(ammonia_conc_flattened,
                                                            "ammonia_concentration")
creatinine_clearance_kruskal_wallis_dunn <- run_kruskal_wallis_dunn(creatinine_clearance_flattened,
                                                                    "creatinine_clearance")
osmoles_clearance_kruskal_wallis_dunn <- run_kruskal_wallis_dunn(osmoles_clearance_flattened,
                                                                 "osmoles_clearance")
free_water_clearance_kruskal_wallis_dunn <- run_kruskal_wallis_dunn(free_water_clearance_flattened,
                                                                    "free_water_clearance")
reabsorption_rate_kruskal_wallis_dunn <- run_kruskal_wallis_dunn(reabsorption_rate_flattened,
                                                                 "reabsorption_rate")
```

```{r}
run_kruskal_wallis_dunn_time <- function(data, data_name, p_adj_method = "bonferroni", 
                                         alpha = 0.05) {
  kruskal_wallis_result <- data %>% 
    group_by(groups) %>% 
    kruskal_test(val ~ time) 
  
  kruskal_wallis_result_filtered <- kruskal_wallis_result %>% 
    filter(p < alpha)
  
  filename <- paste(data_name, "_kruskal-wallis", ".csv", sep = "")
  dir_name <- "result/time_kruskal_wallis_csv/"
  dir_path <- paste(dir_name, data_name, sep = "")
  if (!dir.exists(dir_path)) {
    dir.create(dir_path, showWarnings = FALSE)
  }
  full_path <- paste(dir_name, data_name, "/",
                     filename, sep = "")
  write_csv(kruskal_wallis_result, full_path)
  
  # Dunn's test post-hoc
  if (nrow(kruskal_wallis_result_filtered) > 0) {
    dunn_result <- data %>% 
      group_by(groups) %>% 
      filter(groups %in% kruskal_wallis_result_filtered$groups) %>% 
      dunn_test(val ~ time, p.adjust.method = p_adj_method)
  
    dunn_filename <- paste(data_name, "_dunn", ".csv", sep = "")
    dunn_full_path <- paste(dir_name, data_name, "/", dunn_filename, sep = "")
    write_csv(dunn_result, dunn_full_path)
  }
  else {
    dunn_result <- NULL
  }
  
  kruskal_wallis_aggr <- list("kruskal-wallis_unfiltered" = kruskal_wallis_result,
                              "dunn_unfiltered" = dunn_result)
  
  return(kruskal_wallis_aggr)
}

# kruskal_wallis_result <- creatinine_clearance_flattened %>% 
#   group_by(groups) %>% 
#   kruskal_test(val ~ time)
# 
# kruskal_wallis_result_fitered <- kruskal_wallis_result %>% 
#   filter(p < 0.05)
# 
# dunn_result <- osmotic_pressure_flattened %>% 
#   group_by(groups) %>% 
#   filter(groups %in% kruskal_wallis_result_fitered$groups) %>% 
#   dunn_test(val ~ time, p.adjust.method = "bonferroni")


```


```{r}
urine_creatinine_conc_kruskal_wallis_dunn_time <- run_kruskal_wallis_dunn_time(urine_creatinine_conc_flattened,
                                                                               "urine_creatinine_conc")
urine_flow_rate_kruskal_wallis_dunn_time <- run_kruskal_wallis_dunn_time(urine_flow_rate_flattened,
                                                                         "urine_flow_rate")
osmotic_pressure_kruskal_wallis_dunn_time <- run_kruskal_wallis_dunn_time(osmotic_pressure_flattened,
                                                                          "osmotic_pressure")
ph_kruskal_wallis_dunn_time <- run_kruskal_wallis_dunn_time(ph_flattened,
                                                            "ph")
ammonia_conc_kruskal_wallis_dunn_time <- run_kruskal_wallis_dunn_time(ammonia_conc_flattened,
                                                                      "ammonia_conc")
creatinine_clearance_kruskal_wallis_dunn_time <- run_kruskal_wallis_dunn_time(creatinine_clearance_flattened,
                                                                         "creatinine_clearance")
osmoles_clearance_kruskal_wallis_dunn_time <- run_kruskal_wallis_dunn_time(osmoles_clearance_flattened,
                                                                      "osmoles_clearance")
free_water_clearance_kruskal_wallis_dunn_time <- run_kruskal_wallis_dunn_time(free_water_clearance_flattened,
                                                                         "free_water_clearance")
reabsorption_rate_kruskal_wallis_dunn_time <- run_kruskal_wallis_dunn_time(reabsorption_rate_flattened,
                                                                      "reabsorption_rate")
```


```{r}
# dunn_result <- urine_flow_rate_kruskal_wallis_dunn$dunn_unfiltered
# dunn_result <- dunn_result %>% 
#   add_xy_position(x = "time")
# kruskal_result <- urine_flow_rate_kruskal_wallis_dunn$`kruskal-wallis_unfiltered`
# boxplot <- ggboxplot(urine_flow_rate_flattened, x = "time", y = "val",
#                      color = "groups", palette = "jco") +
#   stat_pvalue_manual(dunn_result, tip.length = 0, hide.ns = TRUE) +
#   labs(subtitle = get_test_label(kruskal_result, detailed = TRUE),
#        caption = get_pwc_label(dunn_result))
# boxplot

create_kruskal_wallis_dunn_boxplots <- function(data, data_name, kruskal_wallis_dunn_result,
                                                p_adj_method = "BH") {
  dunn_result <- kruskal_wallis_dunn_result$dunn_unfiltered
  dunn_result <- dunn_result %>% 
    add_xy_position(x = "time")
  kruskal_wallis_result <- kruskal_wallis_dunn_result$`kruskal-wallis_unfiltered`
  boxplot <- ggboxplot(data, x = "time", y = "val", color = "groups",
                       palette = "jco") +
    stat_pvalue_manual(dunn_result, tip.length = 0, hide.ns = TRUE) +
    labs(subtitle = get_test_label(kruskal_wallis_result, detailed = TRUE),
         caption = get_pwc_label(dunn_result))
  
  filename <- paste(data_name, "_", p_adj_method, ".pdf", sep = "")
  dir_path <- paste("result/group_pairwise_dunn_test_plots/", data_name, sep = "")
  if (!dir.exists(dir_path)) {
    dir.create(dir_path, showWarnings = FALSE)
  }
  full_path <- paste("result/group_pairwise_dunn_test_plots/", data_name, "/", 
                     filename, sep = "")
  ggsave(full_path, boxplot)
  return(boxplot)
}

```

```{r}
create_kruskal_wallis_dunn_boxplots(urine_creatinine_conc_flattened, "urine_creatinine_conc",
                                    urine_creatinine_conc_kruskal_wallis_dunn)
create_kruskal_wallis_dunn_boxplots(urine_flow_rate_flattened, "urine_flow_rate",
                                    urine_flow_rate_kruskal_wallis_dunn)
create_kruskal_wallis_dunn_boxplots(osmotic_pressure_flattened, "osmotic_pressure",
                                    osmotic_pressure_kruskal_wallis_dunn)
create_kruskal_wallis_dunn_boxplots(ph_flattened, "ph",
                                    ph_kruskal_wallis_dunn)
create_kruskal_wallis_dunn_boxplots(ammonia_conc_flattened, "ammonia_conc",
                                    ammonia_conc_kruskal_wallis_dunn)
create_kruskal_wallis_dunn_boxplots(creatinine_clearance_flattened, "creatinine_clearance",
                                    creatinine_clearance_kruskal_wallis_dunn)
create_kruskal_wallis_dunn_boxplots(osmoles_clearance_flattened, "osmoles_clearance",
                                    osmoles_clearance_kruskal_wallis_dunn)
create_kruskal_wallis_dunn_boxplots(free_water_clearance_flattened, "free_water_clearance",
                                    free_water_clearance_kruskal_wallis_dunn)
create_kruskal_wallis_dunn_boxplots(reabsorption_rate_flattened, "reabsorption_rate",
                                    reabsorption_rate_kruskal_wallis_dunn)
                                    
```


# urine flow rate analysis

Focus on group 2

```{r}
urine_flow_rate_cumulative <- read_csv("data/urine_flow_rate_cumulative_all_groups.csv", 
                            locale = locale(encoding = "UTF-8"))

urine_flow_rate_cumulative_stats <- summarize_data(urine_flow_rate_cumulative)
urine_flow_rate_cumulative_summary_df <- create_summary_df(urine_flow_rate_cumulative_stats)
urine_flow_rate_cumulative_summary_tibble <- create_summary_tibble(urine_flow_rate_cumulative_stats)
```

```{r}
urine_flow_rate_cumulative_summary_df_group2 <- urine_flow_rate_cumulative_summary_df %>% 
  filter(group == 2)

```


```{r}
urine_amount_cumulative <- read_csv("data/urine_amount_cumulative_all_groups.csv",
                                    locale = locale(encoding = "UTF-8"))
urine_amount_cumulative_stas <- summarize_data(urine_amount_cumulative)
urine_amount_cumulative_summary_df <- create_summary_df(urine_amount_cumulative_stas)
urine_amount_cumulative_summary_df_group2 <- urine_amount_cumulative_summary_df %>% 
  filter(group == 2)
```


## linear regression

```{r}
urine_flow_rate_cumulative_lm <- lm(mean ~ time, data = urine_flow_rate_cumulative_summary_df_group2)
lm_summary <- summary(urine_flow_rate_cumulative_lm)
lm_summary$coefficients
```

```{r}
urine_amount_cumulative_lm <- lm(mean ~ time, data = urine_amount_cumulative_summary_df_group2)
urine_amount_cumulative_lm_summary <- summary(urine_amount_cumulative_lm)
slope <- urine_amount_cumulative_lm_summary$coefficients[2,1]
intercept <- urine_amount_cumulative_lm_summary$coefficients[1,1]
ggplot(data = urine_amount_cumulative_summary_df_group2, aes(x = time, y = mean)) +
  geom_point(color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "red", size = 1) +
  geom_errorbar(aes(ymin = mean - standard_error,
                    ymax = mean + standard_error,
                    width = 1.8)) +
  scale_x_continuous(breaks = seq(0, 120, by = 30)) +
  theme_classic() +
  labs(x = "Time (min)", y = "Urine Volume (mL)") +
  # ggsave("result/urine_volume_cumulative_210921.pdf")
```


```{r}
urine_flow_rate_cumulative_summary_df_group2_df <- data.frame(urine_flow_rate_cumulative_summary_df_group2)

ggplot(data = urine_flow_rate_cumulative_summary_df_group2, aes(x = time, y = mean)) +
  geom_point(color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "red", size = 1) + 
  geom_errorbar(aes(ymin = mean - standard_error,
                    ymax = mean + standard_error,
                    width = 1.8))+
  scale_x_continuous(breaks = seq(0, 120, by = 30)) +
  theme_classic() 

```

# time significance plots

```{r}
create_select_time_plots <- function(summary_df, group) {
    # Args:
    #   summary_df: data frame
    summary_df %>% 
        filter(group == group) %>% 
        ggplot(aes(x = time, y = mean)) +
        geom_point(color = "blue") +
        geom_line(color = "blue") +
        geom_errorbar(aes(ymin = mean - standard_error,
                          ymax = mean + standard_error,
                          width = 1.8),
                      color = "blue") +
        scale_x_continuous(breaks = seq(0, 120, by = 30)) +
        theme_classic() +
        labs(subtitle = paste("group: ", group, sep = ""))
}
```

```{r}
time_vs_urine_flow_rate_group2 <- create_select_time_plots(urine_flow_rate_summary_df, 2)
time_vs_urine_flow_rate_group2 +
  labs(x = "Time (min)", y = "Urine flow rate (mL/min)") +
  ggsave("result/time_plots/urine_flow_rate/time_vs_urine_flow_rate_group2.pdf")
```


```{r}
time_vs_urine_flow_rate_group2 <- create_select_time_plots(urine_flow_rate_summary_df, 2)
urine_flow_rate_summary_df %>% 
  filter(group == 2) %>% 
  ggplot(aes(x = time, y = mean)) +
  geom_point(color = "blue") +
  geom_line(color = "blue") +
  geom_errorbar(aes(ymin = mean - standard_error,
                    ymax = mean + standard_error,
                    width = 1.8), 
                color = "blue") +
  scale_x_continuous(breaks = seq(0, 120, by = 30)) +
  theme_classic() +
  labs(x = "Time (min)",
       y = "Urine flow rate (mL/min)",
       subtitle = "group: 2") +
  ggsave("result/time_plots/urine_flow_rate/time_vs_urine_flow_rate_group2.pdf")
```

```{r}
reabsorption_rate_summary_df %>% 
  filter(group == 2) %>% 
  ggplot(aes(x = time, y = mean)) +
  geom_point(color = "blue") +
  geom_line(color = "blue") +
  geom_errorbar(aes(ymin = mean - standard_error,
                    ymax = mean + standard_error,
                    width = 1.8), 
                color = "blue") +
  scale_x_continuous(breaks = seq(0, 120, by = 30)) +
  theme_classic() +
  labs(x = "Time (min)",
       y = "Water Reabsorption Rate (%)",
       subtitle = "group: 2") +
  ggsave("result/time_plots/reabsorption_rate/time_vs_reabsorption_rate_group2.pdf")
```

```{r}
osmotic_pressure_summary_df %>% 
  filter(group == 2) %>% 
  ggplot(aes(x = time, y = mean)) +
  geom_point(color = "blue") +
  geom_line(color = "blue") +
  geom_errorbar(aes(ymin = mean - standard_error,
                    ymax = mean + standard_error,
                    width = 1.8), 
                color = "blue") +
  scale_x_continuous(breaks = seq(0, 120, by = 30)) +
  theme_classic() +
  labs(x = "Time (min)",
       y = "Osmotic pressure (mOsm/kg/H2O)",
       subtitle = "group: 2") +
  ggsave("result/time_plots/osmotic_pressure/time_vs_osmotic_pressure_group2.pdf")
  
```

```{r}
ammonia_conc_summary_df %>% 
  filter(group == 2) %>% 
  ggplot(aes(x = time, y = mean)) +
  geom_point(color = "blue") +
  geom_line(color = "blue") +
  geom_errorbar(aes(ymin = mean - standard_error,
                    ymax = mean + standard_error,
                    width = 1.8), 
                color = "blue") +
  scale_x_continuous(breaks = seq(0, 120, by = 30)) +
  theme_classic() +
  labs(x = "Time (min)",
       y = "[Ammonia] (g/L)",
       subtitle = "group: 2") +
  ggsave("result/time_plots/ammonia_concentration/time_vs_ammonia_concentration_group2.pdf")
```

```{r}
urine_creatinine_conc_summary_df %>% 
  filter(group == 2) %>% 
  ggplot(aes(x = time, y = mean)) +
  geom_point(color = "blue") +
  geom_line(color = "blue") +
  geom_errorbar(aes(ymin = mean - standard_error,
                    ymax = mean + standard_error,
                    width = 1.8), 
                color = "blue") +
  scale_x_continuous(breaks = seq(0, 120, by = 30)) +
  theme_classic() +
  labs(x = "Time (min)",
       y = "[Creatinine] (mg/dL)",
       subtitle = "group: 2") +
  ggsave("result/time_plots/urine_creatinine_conc/time_vs_urine_creatinine_conc_group2.pdf")
```

```{r}
ph_summary_df %>% 
  filter(group == 4) %>% 
  ggplot(aes(x = time, y = mean)) +
  geom_point(color = "blue") +
  geom_line(color = "blue") +
  geom_errorbar(aes(ymin = mean - standard_error,
                    ymax = mean + standard_error,
                    width = 1.8), 
                color = "blue") +
  scale_x_continuous(breaks = seq(0, 120, by = 30)) +
  theme_classic() +
  labs(x = "Time (min)",
       y = "pH",
       subtitle = "group: 4") +
  ggsave("result/time_plots/ph/time_vs_ph_group4.pdf")
```

```{r}
ammonia_conc_summary_df %>% 
  filter(group == 4) %>% 
  ggplot(aes(x = time, y = mean)) +
  geom_point(color = "blue") +
  geom_line(color = "blue") +
  geom_errorbar(aes(ymin = mean - standard_error,
                    ymax = mean + standard_error,
                    width = 1.8), 
                color = "blue") +
  scale_x_continuous(breaks = seq(0, 120, by = 30)) +
  theme_classic() +
  labs(x = "Time (min)",
       y = "[Ammonia] (g/L)",
       subtitle = "group: 4") +
  ggsave("result/time_plots/ammonia_concentration/time_vs_ammonia_concentration_group4.pdf")
```

```{r}
ph_summary_df %>% 
  filter(group == 5) %>% 
  ggplot(aes(x = time, y = mean)) +
  geom_point(color = "blue") +
  geom_line(color = "blue") +
  geom_errorbar(aes(ymin = mean - standard_error,
                    ymax = mean + standard_error,
                    width = 1.8), 
                color = "blue") +
  scale_x_continuous(breaks = seq(0, 120, by = 30)) +
  theme_classic() +
  labs(x = "Time (min)",
       y = "pH",
       subtitle = "group: 5") +
  ggsave("result/time_plots/ph/time_vs_ph_group5.pdf")
```

```{r}
urine_flow_rate_summary_df %>% 
  filter(group == 6) %>% 
  ggplot(aes(x = time, y = mean)) +
  geom_point(color = "blue") +
  geom_line(color = "blue") +
  geom_errorbar(aes(ymin = mean - standard_error,
                    ymax = mean + standard_error,
                    width = 1.8), 
                color = "blue") +
  scale_x_continuous(breaks = seq(0, 120, by = 30)) +
  theme_classic() +
  labs(x = "Time (min)",
       y = "Urine flow rate (mL/min)",
       subtitle = "group: 6") +
  ggsave("result/time_plots/urine_flow_rate/time_vs_urine_flow_rate_group6.pdf")
```

```{r}
osmotic_pressure_summary_df %>% 
  filter(group == 6) %>% 
  ggplot(aes(x = time, y = mean)) +
  geom_point(color = "blue") +
  geom_line(color = "blue") +
  geom_errorbar(aes(ymin = mean - standard_error,
                    ymax = mean + standard_error,
                    width = 1.8), 
                color = "blue") +
  scale_x_continuous(breaks = seq(0, 120, by = 30)) +
  theme_classic() +
  labs(x = "Time (min)",
       y = "Osmotic pressure (mOsm/kg/H2O)",
       subtitle = "group: 6") +
  ggsave("result/time_plots/osmotic_pressure/time_vs_osmotic_pressure_group6.pdf")
```


```{r}
urine_flow_rate_summary_df %>% 
  filter(group == 3) %>% 
  ggplot(aes(x = time, y = mean)) +
  geom_point(color = "steelblue") +
  geom_line(color = "steelblue") +
  geom_errorbar(aes(ymin = mean - standard_error,
                    ymax = mean + standard_error,
                    width = 1.8), 
                color = "steelblue") +
  scale_x_continuous(breaks = seq(0, 120, by = 30)) +
  theme_classic() +
  labs(x = "Time (min)",
       y = "Urine Flow Rate (mL/min)",
       subtitle = "group: 3") +
  ggsave("result/time_plots/urine_flow_rate/time_vs_urine_flow_rate_group3.pdf")
```


```{r}
reabsorption_rate_summary_df %>% 
  filter(group == 3) %>% 
  ggplot(aes(x = time, y = mean)) +
  geom_point(color = "steelblue") +
  geom_line(color = "steelblue") +
  geom_errorbar(aes(ymin = mean - standard_error,
                    ymax = mean + standard_error,
                    width = 1.8), 
                color = "steelblue") +
  scale_x_continuous(breaks = seq(0, 120, by = 30)) +
  theme_classic() +
  labs(x = "Time (min)",
       y = "Water Reabsorption Rate (%)",
       subtitle = "group: 3") +
  ggsave("result/time_plots/reabsorption_rate/time_vs_reabsorption_rate_group3.pdf")
```


```{r}
creatinine_clearance_summary_df %>% 
  filter(group == 3) %>% 
  ggplot(aes(x = time, y = mean)) +
  geom_point(color = "steelblue") +
  geom_line(color = "steelblue") +
  geom_errorbar(aes(ymin = mean - standard_error,
                    ymax = mean + standard_error,
                    width = 1.8), 
                color = "steelblue") +
  scale_x_continuous(breaks = seq(0, 120, by = 30)) +
  theme_classic() +
  labs(x = "Time (min)",
       y = "Creatinine clearance (mL/min)",
       subtitle = "group: 3") +
  ggsave("result/time_plots/creatinine_clearance/time_vs_creatinine_clearance_group3.pdf")
```

```{r}
osmotic_pressure_summary_df %>% 
  filter(group == 3) %>% 
  ggplot(aes(x = time, y = mean)) +
  geom_point(color = "steelblue") +
  geom_line(color = "steelblue") +
  geom_errorbar(aes(ymin = mean - standard_error,
                    ymax = mean + standard_error,
                    width = 1.8), 
                color = "steelblue") +
  scale_x_continuous(breaks = seq(0, 120, by = 30)) +
  theme_classic() +
  labs(x = "Time (min)",
       y = "Osmotic Pressre (mOsm/kg/H2O)",
       subtitle = "group: 3") +
  ggsave("result/time_plots/osmotic_pressure/time_vs_osmotic_pressure_group3.pdf")
```


# Group 3 analysis

```{r}
urine_flow_rate_flattened %>% 
  filter(groups == 3) %>% 
  filter(time == 0 | time == 90) %>% 
  group_by(time) %>% 
  get_summary_stats(val, type = "median_iqr")
  
```


```{r}
urine_flow_rate_group3_0_90 <- urine_flow_rate_flattened %>% 
  filter(groups == 3) %>% 
  filter(time == 0 | time == 90) %>% 
  wilcox_test(val ~ time)

urine_flow_rate_group3_0_90_mann_whitney <- urine_flow_rate_group3_0_90 %>% 
  wilcox_test(val ~ time) %>% 
  add_significance()
```

```{r}
urine_flow_rate_group3_0_90_mann_whitney <- wilcox.test(val ~ time, 
                                                        data = urine_flow_rate_group3_0_90, 
                                                        exact = FALSE)
urine_flow_rate_group3_0_90_mann_whitney_plot <- ggboxplot(data = urine_flow_rate_group3_0_90, 
                                                           x = "time", y = "val",
                                                           color = "time", add = "jitter",
                                                           palette = c("steelblue", "indianred"),
                                                           width = 0.2) +
  labs(x = "Time (min)", y = "Urine flow rate (mL/min)")
urine_flow_rate_group3_0_90_mann_whitney_plot +
  ggsave("result/mann_whitney/group3/urine_flow_rate/urine_flow_rate.pdf")
  
```

```{r}
reabsorption_rate_group3_0_90 <- reabsorption_rate_flattened %>% 
  filter(groups == 3) %>% 
  filter(time == 0 | time == 90)

reabsorption_rate_group3_0_90_mann_whitney <- wilcox.test(val ~ time, 
                                                        data = reabsorption_rate_group3_0_90, 
                                                        exact = FALSE)
reabsorption_rate_group3_0_90_mann_whitney_plot <- ggboxplot(data = reabsorption_rate_group3_0_90, 
                                                           x = "time", y = "val",
                                                           color = "time", add = "jitter",
                                                           palette = c("steelblue", "indianred"),
                                                           width = 0.2) +
  labs(x = "Time (min)", y = "Reabsorption Rate (%)")
reabsorption_rate_group3_0_90_mann_whitney_plot +
  ggsave("result/mann_whitney/group3/reabsorption_rate/reabsorption_rate.pdf")
```

```{r}
osmotic_pressure_group3_0_90 <- osmotic_pressure_flattened %>% 
  filter(groups == 3) %>% 
  filter(time == 0 | time == 90)

osmotic_pressure_group3_0_90_mann_whitney <- wilcox.test(val ~ time, 
                                                        data = osmotic_pressure_group3_0_90, 
                                                        exact = FALSE)
osmotic_pressure_group3_0_90_mann_whitney_plot <- ggboxplot(data = osmotic_pressure_group3_0_90, 
                                                           x = "time", y = "val",
                                                           color = "time", add = "jitter",
                                                           palette = c("steelblue", "indianred"),
                                                           width = 0.2) +
  labs(x = "Time (min)", y = "Osmotic Pressure (mOsm/kg/H2O)")
osmotic_pressure_group3_0_90_mann_whitney_plot +
  ggsave("result/mann_whitney/group3/osmotic_pressure/osmotic_pressure.pdf")
```

```{r}
urine_flow_rate_group3_0_60 <- urine_flow_rate_flattened %>% 
  filter(groups == 3) %>% 
  filter(time == 0 | time == 60)
urine_flow_rate_group3_0_60_mann_whitney <- wilcox.test(val ~ time, 
                                                        data = urine_flow_rate_group3_0_60, 
                                                        exact = FALSE)
urine_flow_rate_group3_0_60_mann_whitney_plot <- ggboxplot(data = urine_flow_rate_group3_0_60, 
                                                           x = "time", y = "val",
                                                           color = "time", add = "jitter",
                                                           palette = c("steelblue", "indianred"),
                                                           width = 0.2) +
  labs(x = "Time (min)", y = "Urine flow rate (mL/min)")
urine_flow_rate_group3_0_60_mann_whitney_plot +
  ggsave("result/mann_whitney/group3/urine_flow_rate/urine_flow_rate_0_60.pdf")
```

```{r}
reabsorption_rate_group3_0_60 <- reabsorption_rate_flattened %>% 
  filter(groups == 3) %>% 
  filter(time == 0 | time == 60)

reabsorption_rate_group3_0_60_mann_whitney <- wilcox.test(val ~ time, 
                                                        data = reabsorption_rate_group3_0_60, 
                                                        exact = FALSE)
reabsorption_rate_group3_0_60_mann_whitney_plot <- ggboxplot(data = reabsorption_rate_group3_0_60, 
                                                           x = "time", y = "val",
                                                           color = "time", add = "jitter",
                                                           palette = c("steelblue", "indianred"),
                                                           width = 0.2) +
  labs(x = "Time (min)", y = "Reabsorption Rate (%)")
reabsorption_rate_group3_0_60_mann_whitney_plot +
  ggsave("result/mann_whitney/group3/reabsorption_rate/reabsorption_rate_0_60.pdf")
```


```{r}
osmotic_pressure_group3_0_60 <- osmotic_pressure_flattened %>% 
  filter(groups == 3) %>% 
  filter(time == 0 | time == 60)

osmotic_pressure_group3_0_60_mann_whitney <- wilcox.test(val ~ time, 
                                                        data = osmotic_pressure_group3_0_60, 
                                                        exact = FALSE)
osmotic_pressure_group3_0_60_mann_whitney_plot <- ggboxplot(data = osmotic_pressure_group3_0_60, 
                                                           x = "time", y = "val",
                                                           color = "time", add = "jitter",
                                                           palette = c("steelblue", "indianred"),
                                                           width = 0.2) +
  labs(x = "Time (min)", y = "Osmotic Pressure (mOsm/kg/H2O)")
osmotic_pressure_group3_0_60_mann_whitney_plot +
  ggsave("result/mann_whitney/group3/osmotic_pressure/osmotic_pressure_0_60.pdf")
```

```{r}
creatinine_clearance_group3_0_30 <- creatinine_clearance_flattened %>% 
  filter(groups == 3) %>% 
  filter(time == 0 | time == 30)

creatinine_clearance_group3_0_30_mann_whitney <- wilcox.test(val ~ time, 
                                                        data = creatinine_clearance_group3_0_30, 
                                                        exact = FALSE)
creatinine_clearance_group3_0_30_mann_whitney_plot <- ggboxplot(data = creatinine_clearance_group3_0_30, 
                                                           x = "time", y = "val",
                                                           color = "time", add = "jitter",
                                                           palette = c("steelblue", "indianred"),
                                                           width = 0.2) +
  labs(x = "Time (min)", y = "Creatinine Clearance (mL/min)")
creatinine_clearance_group3_0_30_mann_whitney_plot +
  ggsave("result/mann_whitney/group3/creatinine_clearance/creatinine_clearance_0_30.pdf")
```

